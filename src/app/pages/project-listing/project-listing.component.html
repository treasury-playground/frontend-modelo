<div class="d-flex justify-content-between align-items-center mb-4">
  <h5 class="fw-bold">Listagem</h5>
</div>

<div class="card shadow-sm p-4">
  <div class="position-relative mb-3">
    <input
      type="text"
      [formControl]="searchControl"
      class="form-control rounded-3 w-100 ps-3 pe-5"
      placeholder="Pesquisar por Projeto"
    />
    <i class="bi bi-search position-absolute top-50 end-0 translate-middle-y me-3 text-muted" style="pointer-events: none;"></i>
  </div>

  <div class="mb-3 text-muted small">
    Projetos ({{ filteredProjectsList.length < 10 ? '0' + filteredProjectsList.length : filteredProjectsList.length }})
  </div>

  <table class="table table-hover align-middle">
    <thead class="table-light">
      <tr>
        <th></th>
        <th role="button" (click)="sortBy('name')">Nome do Projeto <i class="bi" [ngClass]="getSortIcon('name')"></i></th>
        <th role="button" (click)="sortBy('description')">Descrição <i class="bi" [ngClass]="getSortIcon('description')"></i></th>
        <th role="button" (click)="sortBy('date')">Data <i class="bi" [ngClass]="getSortIcon('date')"></i></th>
        <th role="button" (click)="sortBy('coordinator')">Coordenador <i class="bi" [ngClass]="getSortIcon('coordinator')"></i></th>
        <th>Estudantes</th>
        <th class="text-end">
          <div class="d-flex justify-content-end align-items-center gap-2">
            <button class="btn btn-outline-secondary btn-sm rounded-3" [disabled]="!hasSelectedProjects()" (click)="downloadSelectedProjects()">Download</button>
            <button *ngIf="userType === 'teacher'" class="btn btn-outline-danger btn-sm rounded-3" [disabled]="!hasSelectedProjects()" (click)="deleteSelectedProjects()">Excluir</button>
          </div>
        </th>
        <th class="text-center">
          <input type="checkbox" [(ngModel)]="selectAll" (change)="toggleSelectAll()" />
        </th>
      </tr>
    </thead>

    <tbody>
      <ng-container *ngFor="let project of paginatedProjects; let i = index">
        <tr class="table-row-hover">
          <td>
            <i class="bi" [ngClass]="{ 'bi-chevron-down': expandedIndex === i, 'bi-chevron-right': expandedIndex !== i }" (click)="toggleDetails(i)" role="button"></i>
          </td>
          <td>{{ project.name }}</td>
          <td class="text-muted small">{{ project.description }}</td>
          <td>{{ project.date }}</td>
          <td><span class="badge bg-info text-dark">{{ project.coordinator }}</span></td>
          <td>
            <span *ngFor="let student of project.assignedStudents || []" class="badge me-1"
                  [ngClass]="{
                    'bg-warning text-dark': student.role === 'Trainee',
                    'bg-info text-dark': student.role === 'Junior',
                    'bg-success text-white': student.role === 'Senior',
                    'bg-primary text-white': student.role === 'Master',
                    'bg-secondary': !student.role
                  }">
              {{ student.name }} <span *ngIf="student.role">— {{ student.role }}</span>
            </span>
          </td>
          <td class="text-end">
            <i *ngIf="userType === 'teacher'" class="bi bi-pencil text-primary" role="button" (click)="onEditProject(project)"></i>
          </td>
          <td class="text-center">
            <input type="checkbox" [(ngModel)]="project.selected" />
          </td>
        </tr>

        <tr *ngIf="expandedIndex === i">
          <td colspan="8">
            <div class="d-flex gap-4 p-3 border rounded-3">
              <div class="flex-fill">
                <img src="" class="img-fluid rounded-3 shadow-sm" alt="Preview" />
              </div>
              <div style="min-width: 300px;">
                <p><strong>Nome do Projeto:</strong> {{ project.name }}</p>
                <p><strong>Descrição:</strong> {{ project.description }}</p>
                <p><strong>Coordenador:</strong> <span class="badge bg-info text-dark">{{ project.coordinator }}</span></p>
                <p><strong>Estudantes:</strong>
                  <ng-container *ngFor="let s of project.assignedStudents || []">
                    <span class="badge me-1"
                          [ngClass]="{
                            'bg-warning text-dark': s.role === 'Trainee',
                            'bg-info text-dark': s.role === 'Junior',
                            'bg-success text-white': s.role === 'Senior',
                            'bg-primary text-white': s.role === 'Master',
                            'bg-secondary': !s.role
                          }">
                      {{ s.name }} <span *ngIf="s.role">— {{ s.role }}</span>
                    </span>
                  </ng-container>
                </p>
              </div>
            </div>
          </td>
        </tr>
      </ng-container>
    </tbody>
  </table>

  <div class="d-flex justify-content-between align-items-center mt-4">
    <span class="small text-muted">
      Mostrando {{ paginatedProjects.length }} de {{ filteredProjectsList.length }}
    </span>
    <div class="d-flex align-items-center gap-2">
      <button class="btn btn-sm btn-outline-primary rounded-3" [disabled]="currentPage === 1" (click)="changePage(currentPage - 1)">‹</button>
      <span>{{ currentPage }}</span>
      <button class="btn btn-sm btn-outline-primary rounded-3" [disabled]="currentPage >= totalPages()" (click)="changePage(currentPage + 1)">›</button>

      <select class="form-select form-select-sm rounded-3 ms-2" style="width: 70px;" [(ngModel)]="pageSize">
        <option [ngValue]="2">2</option>
        <option [ngValue]="4">4</option>
        <option [ngValue]="10">10</option>
      </select>
    </div>
  </div>

  <div class="text-end mt-4" *ngIf="userType === 'teacher'">
    <button class="btn btn-primary rounded-3" (click)="openModal()">
      <i class="bi bi-plus-lg me-1"></i> Adicionar Novo Projeto
    </button>
  </div>
</div>

<app-project-modal *ngIf="userType === 'teacher' && showModal"
  [isEditMode]="isEditMode"
  [projectToEdit]="projectBeingEdited"
  (close)="closeModal()"
  (save)="handleProjectUpdate($event)">
</app-project-modal>
